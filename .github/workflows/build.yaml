name: Execute and publish image autobuilds
on:
  push:
    branches:
      - master

env:
  AUTOBUILD_OS_PROJECT: 37e471bf9f584ebd986acc44639a5bd4
  OS_CLOUD: openstack

jobs:
  install-deps:
    runs-on: self-hosted
    steps:
      - name: Install apt dependencies
        run: |
          sudo apt update &&
          sudo apt install -y python3-virtualenv \
                              debian-archive-keyring \
                              python3.10-venv \
                              python3-pip \
                              btrfs-progs \
                              qemu-system \
                              qemu-utils \
                              squashfs-tools \
                              multipath-tools \
                              debootstrap dpkg

      - name: Install pip dependencies
        run: |
          sudo pip install python-openstackclient \
                           diskimage-builder

  build-and-publish:
    runs-on: self-hosted
    needs: ["install-deps"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize clouds.yaml
        run: |
          echo "${{ secrets.clouds }}" > clouds.yaml

      - name: Build Mekstack Ubuntu
        run: |
          ELEMENTS_PATH=elements diskimage-builder ubuntu.yaml

      - name: Publish Mekstack Ubuntu
        run: |
          openstack image create \
              --property description="Built on $(date +'%d %B'). Default user: ubuntu" \
              --property hw_qemu_guest_agent=yes \
              --property autobuild=yes \
              --container-format bare \
              --public \
              --project $AUTOBUILD_OS_PROJECT \
              --min-disk 5 \
              --min-ram 1024 \
              --disk-format qcow2 \
              --file ubuntu.qcow2 \
              "Mekstack Ubuntu 22.04.3 LTS"

      - name: Build Mekstack Ubuntu Minimal
        run: |
          ELEMENTS_PATH=elements diskimage-builder ubuntu-minimal.yaml

      - name: Publish Mekstack Ubuntu
        run: |
          openstack image create \
              --property description="Built on $(date +'%d %B'). Default user: ubuntu" \
              --property hw_qemu_guest_agent=yes \
              --property autobuild=yes \
              --container-format bare \
              --public \
              --project $AUTOBUILD_OS_PROJECT \
              --min-disk 3 \
              --min-ram 512 \
              --disk-format qcow2 \
              --file ubuntu.qcow2 \
              "Mekstack Ubuntu minimal 22.04.3 LTS"

      - name: Build Mekstack Debian
        run: |
          ELEMENTS_PATH=elements diskimage-builder debian.yaml

      - name: Publish Mekstack Debian
        run: |
          openstack image create \
              --property description="Built on $(date +'%d %B'). Default user: debian" \
              --property hw_qemu_guest_agent=yes \
              --property autobuild=yes \
              --container-format bare \
              --public \
              --project $AUTOBUILD_OS_PROJECT \
              --min-disk 3 \
              --min-ram 512 \
              --disk-format qcow2 \
              --file debian.qcow2 \
              "Mekstack Debian Bookworm 12"
